[{"id":"9584418c.dafc2","type":"tab","label":"Automations","disabled":false,"info":""},{"id":"8b7c83fb.ab52b","type":"tab","label":"Vacuum","disabled":false,"info":""},{"id":"e1dc0b88.463bb8","type":"server","z":"","name":"Home Assistant","legacy":false,"addon":false,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":false,"cacheJson":true},{"id":"546e31ed.0db1c","type":"mqtt-broker","z":"","name":"Mosquitto","broker":"10.0.1.22","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"4849c0fb.bdc85","type":"api-call-service","z":"9584418c.dafc2","name":"Backlight Red","server":"e1dc0b88.463bb8","version":1,"service_domain":"scene","service":"turn_on","entityId":"scene.monitor_backlight_full_red","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1040,"y":100,"wires":[[]]},{"id":"69a050f4.ae9f8","type":"api-current-state","z":"9584418c.dafc2","name":"Is Backlight On?","server":"e1dc0b88.463bb8","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"light.andrew_monitor_backlight","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":843,"y":33,"wires":[["b8ad3ccf.32cb6"],[]]},{"id":"45d9c30e.322dfc","type":"api-current-state","z":"9584418c.dafc2","name":"Is Backlight On?","server":"e1dc0b88.463bb8","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"light.andrew_monitor_backlight","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":843,"y":101,"wires":[["4849c0fb.bdc85"],[]]},{"id":"b8ad3ccf.32cb6","type":"api-call-service","z":"9584418c.dafc2","name":"Backlight White","server":"e1dc0b88.463bb8","version":1,"service_domain":"scene","service":"turn_on","entityId":"scene.monitor_backlight_full_white","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1039,"y":31,"wires":[[]]},{"id":"2022689a.938918","type":"api-call-service","z":"9584418c.dafc2","name":"Pushover: Opened 1 Minute","server":"e1dc0b88.463bb8","version":1,"service_domain":"notify","service":"pushover","entityId":"","data":"{\t   \"message\": \"The \" & $lowercase(msg.data.new_state.attributes.friendly_name) & \" has been opened for 1 minute\" \t}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":880,"y":280,"wires":[[]]},{"id":"8ec438b6.4eb2e8","type":"api-current-state","z":"9584418c.dafc2","name":"Door Notify On","server":"e1dc0b88.463bb8","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.door_notify","state_type":"habool","state_location":"","override_payload":"none","entity_location":"payload","override_data":"msg","blockInputOverrides":false,"x":480,"y":222,"wires":[["c5124616.c9bd48"],[]]},{"id":"28fa66cd.af058a","type":"trigger","z":"9584418c.dafc2","name":"Wait 1m","op1":"","op2":"0","op1type":"nul","op2type":"str","duration":"1","extend":false,"units":"min","reset":"","bytopic":"all","outputs":1,"x":640,"y":280,"wires":[["2022689a.938918"]]},{"id":"9c1d9c7c.ed9c7","type":"change","z":"9584418c.dafc2","name":"Reset If Closed","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":320,"wires":[["28fa66cd.af058a"]]},{"id":"896f5b34.7b4328","type":"api-call-service","z":"9584418c.dafc2","name":"Pushover","server":"e1dc0b88.463bb8","version":1,"service_domain":"notify","service":"pushover","entityId":"","data":"{\t   \"message\": payload \t}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":940,"y":220,"wires":[[]]},{"id":"4afb860e.3f6418","type":"delay","z":"9584418c.dafc2","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":404,"y":70,"wires":[["c229a5ce.6d4ad8"]]},{"id":"c5124616.c9bd48","type":"template","z":"9584418c.dafc2","name":"Opened","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{ data.new_state.attributes.friendly_name }} opened","output":"str","x":760,"y":220,"wires":[["896f5b34.7b4328"]]},{"id":"cd0b2e22.179f9","type":"ha-api","z":"9584418c.dafc2","name":"Grab Front Image","server":"e1dc0b88.463bb8","protocol":"websocket","method":"get","path":"","data":"{\"type\":\"camera_thumbnail\",\"entity_id\":\"camera.outdoor\"}","dataType":"json","location":"image.front","locationType":"msg","responseType":"json","x":789,"y":440,"wires":[["c86a207b.69e23"]]},{"id":"bcc410c8.b6a6b","type":"inject","z":"9584418c.dafc2","d":true,"name":"Every 20 Minutes During Day","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"*/20 7-17 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":250,"y":500,"wires":[["8ba8954b.c9ac88"]]},{"id":"c8c10914.0497a8","type":"file","z":"9584418c.dafc2","name":"Save File","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"base64","x":1232,"y":498,"wires":[[]]},{"id":"d92ec36c.1f11b","type":"ha-api","z":"9584418c.dafc2","name":"Grab Garden Image","server":"e1dc0b88.463bb8","protocol":"websocket","method":"get","path":"","data":"{\"type\":\"camera_thumbnail\",\"entity_id\":\"camera.backyard_camera\"}","dataType":"json","location":"image.garden","locationType":"msg","responseType":"json","x":789,"y":500,"wires":[["c86a207b.69e23"]]},{"id":"7519c5ac.36284c","type":"ha-api","z":"9584418c.dafc2","name":"Grab Side Image","server":"e1dc0b88.463bb8","protocol":"websocket","method":"get","path":"","data":"{\"type\":\"camera_thumbnail\",\"entity_id\":\"camera.esp_camera\"}","dataType":"json","location":"image.side","locationType":"msg","responseType":"json","x":789,"y":560,"wires":[["c86a207b.69e23"]]},{"id":"c86a207b.69e23","type":"function","z":"9584418c.dafc2","name":"Create msg object","func":"var name = Object.keys(msg.image)[0]\nvar content = Object.values(msg.image)[0].content\nmsg = {\n    filename: `/data/${name}_timelapse/${name}_${Date.now()}.jpg`,\n    payload: content\n}\nreturn msg;","outputs":1,"noerr":0,"x":1033,"y":498,"wires":[["c8c10914.0497a8"]]},{"id":"f9d93af6.184028","type":"server-state-changed","z":"9584418c.dafc2","name":"Door Opened","server":"e1dc0b88.463bb8","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.*_door","entityidfiltertype":"regex","outputinitially":false,"state_type":"habool","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":170,"y":260,"wires":[["8ec438b6.4eb2e8","28fa66cd.af058a"],["9c1d9c7c.ed9c7"]]},{"id":"42796298.a0104c","type":"api-current-state","z":"9584418c.dafc2","name":"Heading Comparison","server":"e1dc0b88.463bb8","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.gate_heading_comparison","state_type":"habool","state_location":"","override_payload":"none","entity_location":"data","override_data":"msg","blockInputOverrides":true,"x":600,"y":682,"wires":[["115d9f48.071141"]]},{"id":"222ebf24.bfbfa","type":"inject","z":"9584418c.dafc2","name":"Every Hour","repeat":"","crontab":"0 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":190,"y":682,"wires":[["3b804cf9.ada174"]]},{"id":"115d9f48.071141","type":"switch","z":"9584418c.dafc2","name":"Last Changed > 4 hours","property":"data.timeSinceChangedMs","propertyType":"msg","rules":[{"t":"gt","v":"14400000","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":850,"y":682,"wires":[["1eab32fa.1312bd"]]},{"id":"c444f1de.8365f","type":"api-call-service","z":"9584418c.dafc2","name":"Pushover","server":"e1dc0b88.463bb8","version":1,"service_domain":"notify","service":"pushover","entityId":"","data":"{\t   \"message\": payload \t}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1280,"y":702,"wires":[[]]},{"id":"c229a5ce.6d4ad8","type":"api-current-state","z":"9584418c.dafc2","name":"Internet Reachable?","server":"e1dc0b88.463bb8","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.internet_reachability","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":612,"y":70,"wires":[["69a050f4.ae9f8"],["45d9c30e.322dfc"]]},{"id":"a8e07bf8.32b8b8","type":"server-state-changed","z":"9584418c.dafc2","d":true,"name":"Internet Reachable?","server":"e1dc0b88.463bb8","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.internet_reachability","entityidfiltertype":"exact","outputinitially":false,"state_type":"habool","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":194,"y":70,"wires":[["4afb860e.3f6418"],["4afb860e.3f6418"]]},{"id":"9aee0f4b.44e93","type":"trigger-state","z":"9584418c.dafc2","name":"Gate Offline/Online","server":"e1dc0b88.463bb8","entityid":"sensor.gate_online_offline","entityidfiltertype":"exact","debugenabled":false,"constraints":[],"constraintsmustmatch":"all","outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","x":290,"y":742,"wires":[["cc1f97c7.911bf8"],[]]},{"id":"1fdf1fb6.8cd5d","type":"function","z":"9584418c.dafc2","name":"Create msg object","func":"var message = \"Gate reports \" + msg.payload + \"..\"\n\nreturn { payload: message,topic:msg.topic };","outputs":1,"noerr":0,"x":1090,"y":722,"wires":[["c444f1de.8365f"]]},{"id":"cc1f97c7.911bf8","type":"api-current-state","z":"9584418c.dafc2","name":"Gate Alert On","server":"e1dc0b88.463bb8","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.gate_alert","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":680,"y":742,"wires":[["1fdf1fb6.8cd5d"],[]]},{"id":"3b804cf9.ada174","type":"api-current-state","z":"9584418c.dafc2","name":"Gate Alert On","server":"e1dc0b88.463bb8","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.gate_alert","state_type":"habool","state_location":"","override_payload":"none","entity_location":"payload","override_data":"msg","blockInputOverrides":false,"x":380,"y":682,"wires":[["42796298.a0104c"],[]]},{"id":"1eab32fa.1312bd","type":"function","z":"9584418c.dafc2","name":"Create msg object","func":"var last_time = msg.data.timeSinceChangedMs\n\nfunction msToTime(duration) {\n  var milliseconds = parseInt((duration % 1000) / 100),\n    seconds = Math.floor((duration / 1000) % 60),\n    minutes = Math.floor((duration / (1000 * 60)) % 60),\n    hours = Math.floor((duration / (1000 * 60 * 60)) % 24);\n\n  hours = (hours < 10) ? \"0\" + hours : hours;\n  minutes = (minutes < 10) ? \"0\" + minutes : minutes;\n  seconds = (seconds < 10) ? \"0\" + seconds : seconds;\n\n  return hours + \":\" + minutes + \":\" + seconds + \".\" + milliseconds;\n}\n\nvar message = msg.data.entity_id + \" last changed \" +  msToTime(last_time) + \" ago\"\n\nreturn { payload: message,topic:msg.topic };","outputs":1,"noerr":0,"x":1090,"y":682,"wires":[["c444f1de.8365f"]]},{"id":"73550501.be7fbc","type":"trigger-state","z":"9584418c.dafc2","name":"Rack Temperature","server":"e1dc0b88.463bb8","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"sensor.rack_exhaust_temperature","entityidfiltertype":"exact","debugenabled":false,"constraints":[],"constraintsmustmatch":"all","outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"num","x":190,"y":920,"wires":[["7dff3ae1.e36a04"],[]]},{"id":"7dff3ae1.e36a04","type":"switch","z":"9584418c.dafc2","name":"Above 90?","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"95","vt":"num"},{"t":"lte","v":"90","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":410,"y":920,"wires":[["4a08faf7.7fa704"],["96b5207d.407dd","afde2b6d.39eb88"]]},{"id":"88822bfe.2cc598","type":"api-call-service","z":"9584418c.dafc2","name":"Turn on Fan","server":"e1dc0b88.463bb8","version":1,"service_domain":"homeassistant","service":"turn_on","entityId":"fan.rack_fan","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":true,"x":850,"y":862,"wires":[[]]},{"id":"96b5207d.407dd","type":"api-current-state","z":"9584418c.dafc2","name":"Rack Fan","server":"e1dc0b88.463bb8","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"fan.rack_fan","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":640,"y":940,"wires":[["c7ff978f.ff0728"],[]]},{"id":"b259f0eb.3e83","type":"api-call-service","z":"9584418c.dafc2","name":"Turn off fan","server":"e1dc0b88.463bb8","version":1,"service_domain":"homeassistant","service":"turn_off","entityId":"fan.rack_fan","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":true,"x":1090,"y":962,"wires":[[]]},{"id":"980401d8.8a94b","type":"api-call-service","z":"9584418c.dafc2","name":"Turn on Down Draft Fan","server":"e1dc0b88.463bb8","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"turn_on","entityId":"switch.rack_down_draft","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":true,"x":890,"y":902,"wires":[[]]},{"id":"a7ac6080.13999","type":"api-call-service","z":"9584418c.dafc2","name":"Turn off Downdraft","server":"e1dc0b88.463bb8","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"turn_off","entityId":"switch.rack_down_draft","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":true,"x":1110,"y":1002,"wires":[[]]},{"id":"fa90c550.d6c948","type":"inject","z":"9584418c.dafc2","name":"At 8 PM","repeat":"","crontab":"00 20 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":180,"y":1122,"wires":[["e93027cb.6a6308"]]},{"id":"e93027cb.6a6308","type":"api-current-state","z":"9584418c.dafc2","name":"Master Bedroom Lamps on?","server":"e1dc0b88.463bb8","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"light.master_bedroom_lamps","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":480,"y":1122,"wires":[["fc81cfda.29ff5"],[]]},{"id":"fc81cfda.29ff5","type":"api-call-service","z":"9584418c.dafc2","name":"Set brightness to 128","server":"e1dc0b88.463bb8","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.master_bedroom_lamps","data":"{\"brightness\":\"128\",\"transition\":5}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":801,"y":1122,"wires":[[]]},{"id":"8ba8954b.c9ac88","type":"api-current-state","z":"9584418c.dafc2","name":"Sun Above Horizon","server":"e1dc0b88.463bb8","version":1,"outputs":2,"halt_if":"above_horizon","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"sun.sun","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":530,"y":502,"wires":[["cd0b2e22.179f9","d92ec36c.1f11b","7519c5ac.36284c"],[]]},{"id":"c7ff978f.ff0728","type":"api-current-state","z":"9584418c.dafc2","name":"Rack fan auto off?","server":"e1dc0b88.463bb8","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.rack_fan_auto_off","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":870,"y":962,"wires":[["b259f0eb.3e83"],[]]},{"id":"29b17ed7.fab972","type":"api-current-state","z":"9584418c.dafc2","name":"Rack Fan","server":"e1dc0b88.463bb8","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"fan.rack_fan","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":640,"y":862,"wires":[[],["88822bfe.2cc598"]]},{"id":"4ec9dec7.15884","type":"api-current-state","z":"9584418c.dafc2","name":"Rack fan auto off?","server":"e1dc0b88.463bb8","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.rack_fan_auto_off","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":870,"y":1002,"wires":[["a7ac6080.13999"],[]]},{"id":"afde2b6d.39eb88","type":"api-current-state","z":"9584418c.dafc2","name":"Downdraft","server":"e1dc0b88.463bb8","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"switch.rack_down_draft","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":650,"y":982,"wires":[["4ec9dec7.15884"],[]]},{"id":"4a08faf7.7fa704","type":"api-current-state","z":"9584418c.dafc2","name":"Downdraft","server":"e1dc0b88.463bb8","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"switch.rack_down_draft","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":650,"y":902,"wires":[[],["980401d8.8a94b"]]},{"id":"1aa251bd.6f0e9e","type":"mqtt in","z":"8b7c83fb.ab52b","name":"/nodered/vacuum_whole_house","topic":"/nodered/vacuum_whole_house","qos":"2","datatype":"auto","broker":"546e31ed.0db1c","x":210,"y":400,"wires":[["29209546.eb968a"]]},{"id":"29209546.eb968a","type":"api-call-service","z":"8b7c83fb.ab52b","name":"Clean Whole House","server":"e1dc0b88.463bb8","version":1,"debugenabled":false,"service_domain":"xiaomi_miio","service":"vacuum_clean_zone","entityId":"vacuum.roborock_s4","data":"{\"repeats\":1,\"zone\":[[21700,33050,26200,37150],[21900,29100,25100,32950],[22050,24850,29850,29150],[27100,29950,29800,31400],[25950,28950,27400,33400]]}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":480,"y":400,"wires":[["3f26c01a.09139"]]},{"id":"3f26c01a.09139","type":"function","z":"8b7c83fb.ab52b","name":"Set global.guest_bedroom_vacuumed = false","func":"global.set('guest_bedroom_vacuumed', false);\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":400,"wires":[[]]},{"id":"17af1404.3ae58c","type":"comment","z":"8b7c83fb.ab52b","name":"Vacuum Whole House Flow","info":"This flow is triggered via the front-end.  When\ntriggered it sends an mqtt message to the \n`/nodered/vacuum_whole_house` topic to trigger\nthis flow.","x":200,"y":340,"wires":[]},{"id":"c4d93198.fbe05","type":"mqtt in","z":"8b7c83fb.ab52b","name":"/nodered/vacuum_room","topic":"/nodered/vacuum_room","qos":"2","datatype":"auto","broker":"546e31ed.0db1c","x":180,"y":840,"wires":[["f278bc96.3cc82"]]},{"id":"f278bc96.3cc82","type":"json","z":"8b7c83fb.ab52b","name":"Parse JSON","property":"payload","action":"","pretty":false,"x":390,"y":840,"wires":[["c36825eb.cffee8"]]},{"id":"c36825eb.cffee8","type":"function","z":"8b7c83fb.ab52b","name":"Set Vacuum Payload","func":"msg.payload.domain = 'xiaomi_miio';\nmsg.payload.service = 'vacuum_clean_zone';\nvar serviceData = {\n    entity_id: 'vacuum.roborock_s4',\n    repeats: msg.payload.repeat\n}\nswitch(msg.payload.room) {\n    case 'Office':\n        serviceData.zone = [[27100,29950,29800,31400]];\n        break;\n    case 'Dining Room':\n        serviceData.zone = [[21900,29100,25100,32950]];\n        break;\n    case 'Kitchen':\n        serviceData.zone = [[26200,32700,29600,35700]];\n        break;\n    case 'Living Room':\n        serviceData.zone = [[25950,28950,27400,33400]];\n        break;\n    case 'Master Bedroom':\n        serviceData.zone = [[21700,33050,26200,37150]];\n        break;\n}\nmsg.payload.data = serviceData;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":600,"y":840,"wires":[["d5d967c9.bdf2a8"]]},{"id":"d5d967c9.bdf2a8","type":"api-call-service","z":"8b7c83fb.ab52b","name":"Vacuum Room","server":"e1dc0b88.463bb8","version":1,"debugenabled":false,"service_domain":"","service":"","entityId":"","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":820,"y":840,"wires":[[]]},{"id":"f545a3c7.f48f7","type":"comment","z":"8b7c83fb.ab52b","name":"Vacuum Room Flow","info":"This flow is triggered via the front-end.  When\na room and repeats is selected it sends an mqtt\nmessage to the `/nodered/vacuum_room` topic to\ntrigger this flow.","x":170,"y":780,"wires":[]},{"id":"687a5cba.3364d4","type":"comment","z":"8b7c83fb.ab52b","name":"Update roborock_s4_last_cleaned sensor value Flow","info":"These flow updates the `roborock_s4_last_cleaned`\nsensor value every 5 minutes.  This is required\nbecause the `value_template` does a relative time\ncalculation to populate the value.  Since the\ncalculation it's done on is calculated from now and\na date of a state attribute it normally only gets\nupdated when the state attribute is updated which\nis typically once a day.  Now it will update it\nevery 5 minutes so that the relative time is\nmostly up to date.","x":270,"y":960,"wires":[]},{"id":"ac96d33b.a72d8","type":"inject","z":"8b7c83fb.ab52b","name":"Every 5 Minutes","repeat":"300","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":190,"y":1020,"wires":[["32580dee.376852"]]},{"id":"32580dee.376852","type":"api-call-service","z":"8b7c83fb.ab52b","name":"Update sensor.roborock_s4_last_cleaned","server":"e1dc0b88.463bb8","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"update_entity","entityId":"sensor.roborock_s4_last_cleaned","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":480,"y":1020,"wires":[[]]},{"id":"eff73d69.94bef","type":"trigger-state","z":"8b7c83fb.ab52b","name":"Vacuum Finished?","server":"e1dc0b88.463bb8","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"vacuum.roborock_s4","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"id":"zvv383i13ro","targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"returning"},{"id":"y0qimkpedh","targetType":"this_entity","targetValue":"","propertyType":"previous_state","propertyValue":"old_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"cleaning"}],"constraintsmustmatch":"all","outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","x":170,"y":580,"wires":[["6b4dbd3d.b90a94"],[]]},{"id":"3a6acd26.194c92","type":"api-call-service","z":"8b7c83fb.ab52b","name":"Set Roborock Daily Run to True","server":"e1dc0b88.463bb8","version":1,"debugenabled":false,"service_domain":"input_boolean","service":"turn_on","entityId":"input_boolean.roborock_daily_run","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":730,"y":540,"wires":[[]]},{"id":"878420a4.abf03","type":"inject","z":"8b7c83fb.ab52b","name":"Every Day at Midnight","repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":210,"y":640,"wires":[["29fbc329.00e52c"]]},{"id":"29fbc329.00e52c","type":"api-call-service","z":"8b7c83fb.ab52b","name":"Reset Roborock Daily Run","server":"e1dc0b88.463bb8","version":1,"debugenabled":false,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.roborock_daily_run","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":480,"y":660,"wires":[[]]},{"id":"dc2428e4.db1488","type":"comment","z":"8b7c83fb.ab52b","name":"Toggling Roborock Daily Run Boolean","info":"These automations manage the state of the\n`roborock_daily_run` input boolean.\n\n**Note:** The clean zone command can only do 5\nzones at a time.  Since we have 6, when it finishes\nthe 5th we check a global variable to see if we've\ncleaned the 6th yet (guest bedroom).  If not we\nclean it then set the daily run input boolean to true.","x":230,"y":520,"wires":[]},{"id":"6b4dbd3d.b90a94","type":"function","z":"8b7c83fb.ab52b","name":"Guest Bedroom vacuumed?","func":"var ran = global.get(\"guest_bedroom_vacuumed\" || false);\nif (!ran) {\n    return [null, msg]\n} else {\n    return [msg, null];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","x":440,"y":580,"wires":[["3a6acd26.194c92"],["91b7944e.2afcd8"]]},{"id":"91b7944e.2afcd8","type":"api-call-service","z":"8b7c83fb.ab52b","name":"Clean Guest Bedroom","server":"e1dc0b88.463bb8","version":1,"debugenabled":false,"service_domain":"xiaomi_miio","service":"vacuum_clean_zone","entityId":"vacuum.roborock_s4","data":"{\"repeats\":1,\"zone\":[[26200,32700,29600,35700]]}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":700,"y":600,"wires":[["989c5ac5.338178"]]},{"id":"989c5ac5.338178","type":"function","z":"8b7c83fb.ab52b","name":"Set global.guest_bedroom_vacuumed = true","func":"global.set('guest_bedroom_vacuumed', true);\nreturn msg;","outputs":1,"noerr":0,"x":1070,"y":600,"wires":[[]]},{"id":"e94108fc.39f848","type":"comment","z":"8b7c83fb.ab52b","name":"Maintenance Notifications Flows","info":"These flows send notifications when filters need\nto be replaced or sensors need to be cleaned.","x":210,"y":1140,"wires":[]},{"id":"342fc890.a13dc8","type":"server-state-changed","z":"8b7c83fb.ab52b","name":"Vacuum State Change","server":"e1dc0b88.463bb8","version":"1","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"vacuum.roborock_s4","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":180,"y":1260,"wires":[["34ddcfd4.31e46","903e6322.0889b","ad4cde13.b0f48","4a0f14ef.b15f7c"]]},{"id":"34ddcfd4.31e46","type":"function","z":"8b7c83fb.ab52b","name":"Check Filter","func":"var hoursLeft = msg.data.new_state.attributes.filter_left;\nif (hoursLeft <= 10) {\n    msg.payload = {\n        data: {\n            \"title\": \"Vacuum Maintenance Alert\",\n            \"message\": \"It's time to order replacement parts for your filter.  There are only \" + hoursLeft + \"hrs remaining.\"\n        }\n    }\n    return [msg, null]\n}\nreturn [null, msg]","outputs":2,"noerr":0,"initialize":"","finalize":"","x":390,"y":1200,"wires":[["2caf5f98.ad1e5"],[]]},{"id":"903e6322.0889b","type":"function","z":"8b7c83fb.ab52b","name":"Check Side Brush","func":"var hoursLeft = msg.data.new_state.attributes.side_brush_left;\nif (hoursLeft <= 10) {\n    msg.payload = {\n        data: {\n            \"title\": \"Vacuum Maintenance Alert\",\n            \"message\": \"It's time to order replacement parts for your side brush.  There are only \" + hoursLeft + \"hrs remaining.\"\n        }\n    }\n    return [msg, null]\n}\nreturn [null, msg]","outputs":2,"noerr":0,"x":410,"y":1240,"wires":[["2caf5f98.ad1e5"],[]],"info":"Sets the msg payload if needed."},{"id":"ad4cde13.b0f48","type":"function","z":"8b7c83fb.ab52b","name":"Check Main Brush","func":"var hoursLeft = msg.data.new_state.attributes.main_brush_left;\nif (hoursLeft <= 10) {\n    msg.payload = {\n        data: {\n            \"title\": \"Vacuum Maintenance Alert\",\n            \"message\": \"It's time to order replacement parts for your main brush.  There are only \" + hoursLeft + \"hrs remaining.\"\n        }\n    }\n    return [msg, null]\n}\nreturn [null, msg]","outputs":2,"noerr":0,"x":410,"y":1280,"wires":[["2caf5f98.ad1e5"],[]]},{"id":"4a0f14ef.b15f7c","type":"function","z":"8b7c83fb.ab52b","name":"Check Sensors","func":"var hoursLeft = msg.data.new_state.attributes.sensor_dirty_left;\nif (hoursLeft <= 2) {\n    msg.payload = {\n        data: {\n            \"title\": \"Vacuum Maintenance Alert\",\n            \"message\": \"It's time to clean the vacuum sensors.  There are 4 cliff sensors on the bottom front and 1 wall sensor on the left of the robot.  There are only \" + hoursLeft + \"hrs remaining.\"\n        }\n    }\n    return [msg, null]\n}\nreturn [null, msg]","outputs":2,"noerr":0,"x":400,"y":1320,"wires":[["2caf5f98.ad1e5"],[]]},{"id":"2caf5f98.ad1e5","type":"api-call-service","z":"8b7c83fb.ab52b","name":"Notify Godfrey","server":"e1dc0b88.463bb8","version":"1","debugenabled":false,"service_domain":"notify","service":"pushover","entityId":"","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":660,"y":1260,"wires":[[]]},{"id":"d075fa5.3436c08","type":"api-current-state","z":"8b7c83fb.ab52b","name":"Roborock Already Run Today?","server":"e1dc0b88.463bb8","version":"1","outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.roborock_daily_run","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":450,"y":120,"wires":[["110d2980.528807"],[]]},{"id":"78da933.8296c6c","type":"inject","z":"8b7c83fb.ab52b","d":true,"name":"Manually Trigger","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":180,"y":100,"wires":[["d075fa5.3436c08"]]},{"id":"aee03f49.26b8f","type":"api-call-service","z":"8b7c83fb.ab52b","name":"Clean First Floor","server":"e1dc0b88.463bb8","version":1,"debugenabled":false,"service_domain":"xiaomi_miio","service":"vacuum_clean_zone","entityId":"vacuum.roborock_s4","data":"{\"repeats\":1,\"zone\":[[21700,33050,26200,37150],[21900,29100,25100,32950],[22050,24850,29850,29150],[27100,29950,29800,31400],[25950,28950,27400,33400]]}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":960,"y":120,"wires":[["75b23a77.316534"]]},{"id":"9c0a226b.33b6f","type":"api-current-state","z":"8b7c83fb.ab52b","name":"Roborock Running?","server":"e1dc0b88.463bb8","version":"1","outputs":2,"halt_if":"cleaning","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"vacuum.roborock_s4","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":760,"y":120,"wires":[["aee03f49.26b8f"],[]]},{"id":"24b0302d.8fb88","type":"trigger-state","z":"8b7c83fb.ab52b","d":true,"name":"Everyone Away?","server":"e1dc0b88.463bb8","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"group.trackers","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"id":"j0ob9uldbc","targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"not_home"},{"id":"7d6k4kkns33","targetType":"this_entity","targetValue":"","propertyType":"previous_state","propertyValue":"old_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"home"}],"constraintsmustmatch":"all","outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","x":190,"y":160,"wires":[["d075fa5.3436c08"],[]]},{"id":"95ef185b.14bd78","type":"inject","z":"8b7c83fb.ab52b","d":true,"name":"Every Day at 2PM","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"00 14 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":190,"y":220,"wires":[["d075fa5.3436c08"]]},{"id":"db0e8ed4.c8edc","type":"comment","z":"8b7c83fb.ab52b","name":"Auto Run Vacuum Automation","info":"This automation can be triggered in 1 of 3 ways:\n\n * Manually invoked by hitting the inject node.\n * When no one is home if it has not run today and is not currently cleaning.\n * If at 2PM someone is still home and it hasn't run today.","x":200,"y":40,"wires":[]},{"id":"75b23a77.316534","type":"function","z":"8b7c83fb.ab52b","name":"Set global.guest_bedroom_vacuumed = false","func":"global.set('guest_bedroom_vacuumed', false);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1230,"y":120,"wires":[[]]},{"id":"110d2980.528807","type":"api-current-state","z":"8b7c83fb.ab52b","name":"Vacation Mode Enabled?","server":"e1dc0b88.463bb8","version":"1","outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.vacation_mode","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":650,"y":60,"wires":[["9c0a226b.33b6f"],[]],"info":"Short circuit this flow if vacation mode is enabled."}]