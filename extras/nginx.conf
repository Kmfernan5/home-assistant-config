###################
# MANAGED BY SALT #
###################

worker_processes  auto;
error_log  /var/log/nginx/error.log;
error_log  /var/log/nginx/error.log  notice;
error_log  /var/log/nginx/error.log  info;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
    use epoll;
}

http {
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # HASS LAN shortcut
    server {
        server_name REDACTED;
        listen 80;
        return 301 http://10.0.1.22:8123;
    }

    # NodeRED Lan Shortcut
    server {
        server_name REDACTED;
        listen 80;
        return 301 http://10.0.1.22:1880;
    }

    # Plex LAN shortcut
    server {
        server_name REDACTED;
        listen 80;
        return 301 https://10.0.1.22:32400;
    }

    # ESPHome LAN shortcut
    server {
        server_name REDACTED;
        listen 80;
        return 301 http://10.0.1.22:6052;
    }

    # Portainer LAN shortcut
    server {
        server_name REDACTED;
        listen 80;
        return 301 http://10.0.1.22:9000;
    }

    # Pihole LAN shortcut
    server {
        server_name REDACTED;
        listen 80;
        return 301 http://10.0.1.22:8000/admin;
    }

    # Grafana LAN shortcut
    server {
        server_name REDACTED;
        listen 80;
        return 301 http://10.0.1.22:3000;
    }

    # Darkstat LAN shortcut
    server {
        server_name REDACTED;
        listen 80;
        return 301 http://10.0.1.1:666;
    }

    ##########################
    #  Server entries below  #
    #    are proxied via     #
    #       Cloudflare       #
    ##########################

    # Cloudflare Node-Red Proxy -- nodered
    server {
        # Ensure these lines point to your SSL certificate and key
        ssl_certificate      /etc/cloudflare/cloudflare.pem;
        ssl_certificate_key  /etc/cloudflare/cloudflare.key;
        server_name REDACTED;
        listen 443 ssl;
        add_header Strict-Transport-Security "max-age=31536000; includeSubdomains";
        proxy_buffering off;
        location / {
            proxy_pass http://127.0.0.1:1880;
            proxy_set_header Host $host;
            proxy_redirect http:// https://;
            proxy_http_version 1.1;
            #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }

    # Cloudflare ESPHome Proxy -- esphome
    server {
        # Ensure these lines point to your SSL certificate and key
        ssl_certificate      /etc/cloudflare/cloudflare.pem;
        ssl_certificate_key  /etc/cloudflare/cloudflare.key;
        server_name REDACTED;
        listen 443 ssl;
        add_header Strict-Transport-Security "max-age=31536000; includeSubdomains";
        proxy_buffering off;
        location / {
            proxy_pass http://127.0.0.1:6052;
            proxy_set_header Host $host;
            proxy_redirect http:// https://;
            proxy_http_version 1.1;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Origin '';
        }
    }

    # Cloudflare Grafana Proxy -- grafana
    server {
        # Ensure these lines point to your SSL certificate and key
        ssl_certificate      /etc/cloudflare/cloudflare.pem;
        ssl_certificate_key  /etc/cloudflare/cloudflare.key;
        server_name REDACTED;
        listen 443 ssl;
        add_header Strict-Transport-Security "max-age=31536000; includeSubdomains";
        proxy_buffering off;
        location / {
            proxy_pass http://127.0.0.1:3000;
            proxy_set_header Host $host;
            proxy_redirect http:// https://;
            proxy_http_version 1.1;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }

    # Cloudflare Plane Proxy -- plane
    server {
        # Ensure these lines point to your SSL certificate and key
        ssl_certificate      /etc/cloudflare/cloudflare.pem;
        ssl_certificate_key  /etc/cloudflare/cloudflare.key;
        server_name REDACTED;
        listen 443 ssl;
        add_header Strict-Transport-Security "max-age=31536000; includeSubdomains";
        proxy_buffering off;
        location / {
            proxy_pass http://10.0.1.12:30053;
            proxy_set_header Host $host;
            proxy_redirect http:// https://;
            proxy_http_version 1.1;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }

    # Cloudflare Home Assistant Proxy -- HASS hass
    server {
        # Ensure these lines point to your SSL certificate and key
        ssl_certificate      /etc/cloudflare/cloudflare.pem;
        ssl_certificate_key  /etc/cloudflare/cloudflare.key;
        server_name REDACTED;
        listen 443 ssl;
        add_header Strict-Transport-Security "max-age=31536000; includeSubdomains";
        proxy_buffering off;
        location / {
            proxy_pass http://127.0.0.1:8123;
            proxy_set_header Host $host;
            proxy_redirect http:// https://;
            proxy_http_version 1.1;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_no_cache 1;
            proxy_cache_bypass 1;
        }
    }

    # Cloudflare Portainer Proxy -- portainer
    server {
        # Ensure these lines point to your SSL certificate and key
        ssl_certificate      /etc/cloudflare/cloudflare.pem;
        ssl_certificate_key  /etc/cloudflare/cloudflare.key;
        server_name REDACTED;
        listen 443 ssl;
        add_header Strict-Transport-Security "max-age=31536000; includeSubdomains";
        proxy_buffering off;
        location / {
            proxy_http_version 1.1;
            proxy_set_header   Connection "";
            proxy_set_header   Host $host;
            proxy_set_header   X-Forwarded-Host $server_name REDACTED;
            add_header         X-Upstream $upstream_addr;
            proxy_pass http://127.0.0.1:9000;
        }
        location /api/websocket/ {
            proxy_buffering off;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "Upgrade";
            proxy_set_header   Host $host;
            proxy_set_header   X-Forwarded-Server $host;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Host $server_name REDACTED;
            add_header         X-Upstream $upstream_addr;
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:9000;
            proxy_redirect http://127.0.0.1:9000 $scheme://$host/;
        }
    }

    # Cloudflare Pihole Proxy -- pihole
    server {
        # Ensure these lines point to your SSL certificate and key
        ssl_certificate      /etc/cloudflare/cloudflare.pem;
        ssl_certificate_key  /etc/cloudflare/cloudflare.key;
        server_name REDACTED;
        listen 443 ssl;
        add_header Strict-Transport-Security "max-age=31536000; includeSubdomains";
        proxy_buffering off;
        location / {
            proxy_pass http://127.0.0.1:8000;
            proxy_set_header Host $host;
            proxy_redirect http:// https://;
            proxy_http_version 1.1;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_no_cache 1;
            proxy_cache_bypass 1;
        }
    }

    # Cloudflare Darkstat Proxy -- darkstat monitoring
    server {
        # Ensure these lines point to your SSL certificate and key
        ssl_certificate      /etc/cloudflare/cloudflare.pem;
        ssl_certificate_key  /etc/cloudflare/cloudflare.key;
        server_name REDACTED;
        listen 443 ssl;
        add_header Strict-Transport-Security "max-age=31536000; includeSubdomains";
        proxy_buffering off;
        location / {
            proxy_pass http://10.0.1.1:666;
            proxy_set_header Host $host;
            proxy_redirect http:// https://;
            proxy_http_version 1.1;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_no_cache 1;
            proxy_cache_bypass 1;
        }
    }
}
