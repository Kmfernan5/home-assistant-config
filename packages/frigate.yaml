automation:
  - alias: Frigate Notifications
    id: "frigate_notifications"
    mode: single
    trigger:
      - platform: mqtt
        topic: frigate/events
        payload: new
        value_template: "{{ value_json.type }}"
    action:
      # if home and person detection at front door then notify
      - if:
          - "{{ (is_state('input_boolean.security_status', 'off') and trigger.payload_json['after']['camera'] == 'front_door') and trigger.payload_json['after']['label'] == 'person' }}"
        then:
          - service: notify.signal_frigate
            data:
              message: >-
                A {{trigger.payload_json["after"]["label"]}} was detected.


                Clip: https://secret/api/frigate/notifications/{{trigger.payload_json["after"]["id"]}}/clip.mp4


                Stream: https://secret/api/camera_proxy_stream/camera.{{trigger.payload_json['after']['camera'].lower()}}?token={{state_attr( 'camera.' ~ trigger.payload_json['after']['camera'].lower(), 'access_token')}}
              data:
                urls:
                  - http://localhost:8123/api/frigate/notifications/{{trigger.payload_json["after"]["id"]}}/snapshot.jpg?bbox=1&timestamp=1&quality=100

      # if not home or sleeping time and person detection anywhere then notify
      - if:
          - "{{ (is_state('input_boolean.security_status', 'on') or is_state('input_boolean.goodnight', 'on')) and trigger.payload_json['after']['label'] == 'person' }}"
        then:
          - service: notify.signal_frigate
            data:
              message: >-
                A {{trigger.payload_json["after"]["label"]}} was detected.


                Clip: https://secret/api/frigate/notifications/{{trigger.payload_json["after"]["id"]}}/clip.mp4


                Stream: https://secret/api/camera_proxy_stream/camera.{{trigger.payload_json['after']['camera'].lower()}}?token={{state_attr( 'camera.' ~ trigger.payload_json['after']['camera'].lower(), 'access_token')}}
              data:
                urls:
                  - http://localhost:8123/api/frigate/notifications/{{trigger.payload_json["after"]["id"]}}/snapshot.jpg?bbox=1&timestamp=1&quality=100

  - alias: Doorbell Ring
    id: "frigate_doorbell_ring"
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.front_door_button_pressed
        to: "on"
    action:
      - service: camera.snapshot
        data:
          filename: /tmp/doorbell.jpg
        target:
          entity_id: camera.front_door
      - service: notify.signal_frigate
        data:
          message: >-
            Doorbell ring!


            Talk Live (you'll have to unmute audio, mic always live!): https://frigate.secret/live/webrtc/webrtc.html?src=front_door_twoway
          data:
            attachments:
              - /tmp/doorbell.jpg
      - service: siren.toggle
        entity_id: siren.garage_chime_siren

  - alias: Frigate Notification Snooze
    id: "frigate_notification_snooze"
    mode: single
    trigger:
      - platform: event
        id: start
        event_type:
          - timer.started
          - timer.restarted
        event_data:
          entity_id: timer.frigate_notification_snooze
      - platform: event
        id: finish
        event_type: timer.finished
        event_data:
          entity_id: timer.frigate_notification_snooze
      - platform: state
        entity_id: automation.frigate_notifications
        to:
          - "on"
          - "off"
        id: manual
      - platform: state
        entity_id: group.trackers
        to: not_home
        id: presence
    action:
      - if: "{{ trigger.id == 'start' }}"
        then:
          - service: homeassistant.turn_off
            entity_id: automation.frigate_notifications
          - delay: "00:00:01"

      - if: "{{ trigger.id in ['finish','presence'] }}"
        then:
          - service: homeassistant.turn_on
            entity_id: automation.frigate_notifications
          - service: timer.cancel
            entity_id: timer.frigate_notification_snooze
          - delay: "00:00:01"

      - if: "{{ trigger.id == 'manual' }}"
        then:
          - service: timer.cancel
            entity_id: timer.frigate_notification_snooze

  - alias: Frigate Notification Snooze Front Door
    id: "frigate_notification_snooze_front_door"
    mode: single
    trigger:
      - platform: state
        id: door
        entity_id: binary_sensor.front_door
        to: "on"
      - platform: event
        id: unlock
        event_type: call_service
        event_data:
          domain: lock
          service: unlock
          service_data:
            entity_id: lock.front_door
    action:
      - if: "{{ trigger.id == 'door' }}"
        then:
          - service: timer.start
            data:
              duration: "00:05:00"
            target:
              entity_id: timer.frigate_notification_snooze
      - if: "{{ trigger.id == 'unlock' }}"
        then:
          - service: timer.start
            data:
              duration: "00:02:00"
            target:
              entity_id: timer.frigate_notification_snooze

  - alias: Front Door Security Light
    id: "frigate_front_door_security_light"
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.front_door_person_occupancy
    condition: "{{ is_state('sun.sun', 'below_horizon')}}"
    action:
      - service: select.select_option
        data:
          option: "{% if trigger.to_state.state == 'on' %}On{% elif trigger.to_state.state == 'off' %}Off{% endif %}"
        target:
          entity_id: select.front_door_security_light

command_line:
  - switch:
      name: Back Porch Camera White Light
      command_on: >
        curl --silent --digest -g "http://USERNAME:PASSWORD@10.0.0.32/cgi-bin/coaxialControlIO.cgi?action=control&channel=1&info[0].Type=1&info[0].IO=1"
      command_off: >
        curl --silent --digest -g "http://USERNAME:PASSWORD@10.0.0.32/cgi-bin/coaxialControlIO.cgi?action=control&channel=1&info[0].Type=1&info[0].IO=0"
      command_state: >
        curl --silent --digest -g "http://USERNAME:PASSWORD@10.0.0.32/cgi-bin/coaxialControlIO.cgi?action=getStatus&channel=0" | grep -q "status.status.WhiteLight=On"

timer:
  frigate_notification_snooze:
    duration: "00:00:00"
    restore: True
